<form class="padding-LR-24 column gap-16" [formGroup]="form">
  <div class="width-100">
    <p class="title-md">بيانات التشخيص</p>
    <span class="home-line"></span>
  </div>

  <!-- Diagnosis -->
  <div class="row flex-center width-100">
    <label class="label-lg">التشخيص</label>
    <textarea rows="2" class="label-lg" formControlName="DiagnosisText"></textarea>

    <!-- Frontend Validation -->
    <div
      class="error-message label-lg"
      *ngIf="FrontendError('DiagnosisText')"
    >
      التشخيص مطلوب
    </div>
  </div>

  <!-- Injury Reasons + Injury Sides -->
  <div class="row flex-center">

    <label class="label-lg">أسباب الإصابة</label>
    <app-multi-select
      formControlName="InjuryReasons"
      [options]="injuryReasonsOptions"
      placeholder="اختر الأسباب"
    ></app-multi-select>
    <!-- Frontend Validation -->
    <div
      class="error-message label-lg"
      *ngIf="FrontendError('InjuryReasons')"
    >
      أسباب الإصابة مطلوبة
    </div>

    <label class="label-lg">جهة الإصابة</label>
    <app-multi-select
      formControlName="InjurySides"
      [options]="injurySidesOptions"
      placeholder="اختر الجهة"
    ></app-multi-select>
    <!-- Frontend Validation -->
    <div
      class="error-message label-lg"
      *ngIf="FrontendError('InjurySides')"
    >
      جهة الإصابة مطلوبة
    </div>

  </div>

  <!-- Injury Types -->
  <div class="row flex-center">

    <label class="label-lg">نوع الإصابة</label>
    <app-multi-select
      formControlName="InjuryTypes"
      [options]="injuryTypesOptions"
      placeholder="اختر النوع"
    ></app-multi-select>

    <!-- Frontend Validation -->
    <div
      class="error-message label-lg"
      *ngIf="FrontendError('InjuryTypes')"
    >
      نوع الإصابة مطلوب
    </div>

  </div>

  <!-- Dates -->
  <div class="row flex-center">
    <label class="label-lg">تاريخ الإصابة</label>
    <input class="label-lg" type="date" formControlName="InjuryDate" />

    <!-- Frontend Validation -->
    <div
      class="error-message label-lg"
      *ngIf="FrontendError('InjuryDate')"
    >
      تاريخ الإصابة مطلوب
    </div>
  </div>

  <div class="row flex-center">

    <label class="label-lg">تاريخ بداية البرنامج</label>
    <input class="label-lg" type="date" formControlName="ProgramStartDate" />
    <!-- Frontend Validation -->
    <div
      class="error-message label-lg"
      *ngIf="FrontendError('ProgramStartDate')"
    >
      تاريخ البداية مطلوب
    </div>

    <label class="label-lg">تاريخ نهاية البرنامج</label>
    <input class="label-lg" type="date" formControlName="ProgramEndDate" />
    <!-- Frontend Validation -->
    <div
      class="error-message label-lg"
      *ngIf="FrontendError('ProgramEndDate')"
    >
      تاريخ النهاية مطلوب
    </div>
  </div>

  <!-- Date Range Error -->
  <div
    class="error-message label-lg flex-center"
    *ngIf="form.errors?.['dateRange'] && form.get('ProgramStartDate')?.touched && form.get('ProgramEndDate')?.touched"
  >
    تاريخ النهاية يجب أن يكون بعد تاريخ البداية
  </div>

  <!-- TherapyCardType -->
  <div class="row flex-center">
    <label class="label-lg">نوع بطاقة العلاج</label>
    <select class="label-lg" formControlName="TherapyCardType">
      <option value="">اختر النوع</option>
      <option *ngFor="let t of therapyTypes" [value]="t.value">
        {{ t.label }}
      </option>
    </select>

    <!-- Frontend Validation -->
    <div
      class="error-message label-lg"
      *ngIf="FrontendError('TherapyCardType')"
    >
      نوع البطاقة مطلوب
    </div>
  </div>

  <!-- Notes -->
  <div class="row flex-center width-100">
    <label class="label-lg">الملاحظات</label>
    <textarea rows="1" class="label-lg" formControlName="Notes"></textarea>
  </div>

  <!-- Programs section -->
  <div class="width-100">
    <p class="title-md">البرامج العلاجية</p>
    <span class="home-line"></span>
  </div>

  <table class="no-shadow">
    <thead>
      <tr>
        <th class="label-lg">اسم البرنامج</th>
        <th class="label-lg">المدة</th>
        <th class="label-lg">الملاحظات</th>
        <th></th>
      </tr>
    </thead>

    <tbody>
      @for (row of programs.controls; track $index; let i = $index) {
      <tr [formGroup]="row">

        <td>
          <select class="label-lg" formControlName="MedicalProgramId">
            <option value="">اختر البرنامج</option>
            <option *ngFor="let p of programDropdown" [value]="p.value">
              {{ p.label }}
            </option>
          </select>

          <!-- Frontend Validation -->
          <div
            class="error-message label-lg"
            *ngIf="row.get('MedicalProgramId')?.invalid && row.get('MedicalProgramId')?.touched"
          >
            البرنامج مطلوب
          </div>
        </td>

        <td>
          <input class="label-lg" type="number" min="1" formControlName="Duration" />

          <!-- Frontend Validation -->
          <div
            class="error-message label-lg"
            *ngIf="row.get('Duration')?.invalid && row.get('Duration')?.touched"
          >
            المدة مطلوبة ويجب أن تكون رقمًا أكبر من 0
          </div>
        </td>

        <td>
          <input class="label-lg" type="text" formControlName="Notes" />
        </td>

        <td>
          <button
            *ngIf="programs.length > 1"
            type="button"
            class="btn danger icon"
            (click)="removeProgramRow(i)"
          >
            ✕
          </button>
        </td>

      </tr>
      }
    </tbody>
  </table>
<div
  *ngIf="programs.errors?.['duplicateProgram']"
  class="error-message label-lg flex-center"
>
  لا يمكن اختيار نفس البرنامج العلاجي أكثر من مرة
</div>

  <div class="flex-end">
    <button class="btn primary" type="button" (click)="addProgramRow()">
      + إضافة برنامج
    </button>
  </div>

  <div class="flex-center">
    <button class="btn primary label-md" type="button" (click)="onSubmit()">
      حفظ
    </button>
  </div>
</form>
