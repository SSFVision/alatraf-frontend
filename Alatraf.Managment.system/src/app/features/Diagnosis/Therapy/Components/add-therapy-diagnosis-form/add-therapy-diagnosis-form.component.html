<form class="padding-LR-24 column gap-16" [formGroup]="form">
  <div class="width-100">
    <p class="title-md">بيانات التشخيص</p>
    <span class="home-line"></span>
  </div>

  <!-- Diagnosis -->
  <div class="row flex-center width-100">
    <label class="label-lg">التشخيص</label>
    <textarea rows="2" class="label-lg" formControlName="DiagnosisText"></textarea>

    <!-- Backend validation -->
    <div class="error-message label-lg" *ngIf="hasBackendError('DiagnosisText')">
      {{ getBackendError('DiagnosisText') }}
    </div>

    <!-- Frontend Validation -->
    <div class="error-message label-lg" *ngIf="hasFrontendError('DiagnosisText')">
      التشخيص مطلوب
    </div>
  </div>

  <!-- Injury Reasons + Injury Sides -->
  <div class="row flex-center">

    <label class="label-lg">أسباب الإصابة</label>
    <app-multi-select
      formControlName="InjuryReasons"
      [options]="injuryReasonsOptions"
      placeholder="اختر الأسباب"
    ></app-multi-select>

    <!-- Backend error -->
    <div class="error-message label-lg" *ngIf="hasBackendError('InjuryReasons')">
      {{ getBackendError('InjuryReasons') }}
    </div>

    <!-- Frontend -->
    <div class="error-message label-lg" *ngIf="hasFrontendError('InjuryReasons')">
      أسباب الإصابة مطلوبة
    </div>

    <label class="label-lg">جهة الإصابة</label>
    <app-multi-select
      formControlName="InjurySides"
      [options]="injurySidesOptions"
      placeholder="اختر الجهة"
    ></app-multi-select>

    <!-- Backend -->
    <div class="error-message label-lg" *ngIf="hasBackendError('InjurySides')">
      {{ getBackendError('InjurySides') }}
    </div>

    <!-- Frontend -->
    <div class="error-message label-lg" *ngIf="hasFrontendError('InjurySides')">
      جهة الإصابة مطلوبة
    </div>

  </div>

  <!-- Injury Types -->
  <div class="row flex-center">

    <label class="label-lg">نوع الإصابة</label>
    <app-multi-select
      formControlName="InjuryTypes"
      [options]="injuryTypesOptions"
      placeholder="اختر النوع"
    ></app-multi-select>

    <!-- Backend -->
    <div class="error-message label-lg" *ngIf="hasBackendError('InjuryTypes')">
      {{ getBackendError('InjuryTypes') }}
    </div>

    <!-- Frontend -->
    <div class="error-message label-lg" *ngIf="hasFrontendError('InjuryTypes')">
      نوع الإصابة مطلوب
    </div>

  </div>

  <!-- Injury Date -->
  <div class="row flex-center">
    <label class="label-lg">تاريخ الإصابة</label>
    <input class="label-lg" type="date" formControlName="InjuryDate" />

    <!-- Backend -->
    <div class="error-message label-lg" *ngIf="hasBackendError('InjuryDate')">
      {{ getBackendError('InjuryDate') }}
    </div>

    <!-- Frontend -->
    <div class="error-message label-lg" *ngIf="hasFrontendError('InjuryDate')">
      تاريخ الإصابة مطلوب
    </div>
  </div>

  <!-- Program dates -->
  <div class="row flex-center">

    <label class="label-lg">تاريخ بداية البرنامج</label>
    <input class="label-lg" type="date" formControlName="ProgramStartDate" />

    <!-- Backend -->
    <div class="error-message label-lg" *ngIf="hasBackendError('ProgramStartDate')">
      {{ getBackendError('ProgramStartDate') }}
    </div>

    <!-- Frontend -->
    <div class="error-message label-lg" *ngIf="hasFrontendError('ProgramStartDate')">
      تاريخ البداية مطلوب
    </div>

    <label class="label-lg">تاريخ نهاية البرنامج</label>
    <input class="label-lg" type="date" formControlName="ProgramEndDate" />

    <!-- Backend -->
    <div class="error-message label-lg" *ngIf="hasBackendError('ProgramEndDate')">
      {{ getBackendError('ProgramEndDate') }}
    </div>

    <!-- Frontend -->
    <div class="error-message label-lg" *ngIf="hasFrontendError('ProgramEndDate')">
      تاريخ النهاية مطلوب
    </div>
  </div>

  <!-- Date Range Error -->
  <div
    class="error-message label-lg flex-center"
    *ngIf="form.errors?.['dateRange'] &&
           form.get('ProgramStartDate')?.touched &&
           form.get('ProgramEndDate')?.touched"
  >
    تاريخ النهاية يجب أن يكون بعد تاريخ البداية
  </div>

  <!-- TherapyCardType -->
<div class="row flex-center">
  <label class="label-lg">نوع بطاقة العلاج</label>

  <select class="label-lg" formControlName="TherapyCardType">
    <option *ngFor="let t of therapyTypes" [value]="t.value">
      {{ t.label }}
    </option>
  </select>

  <!-- Backend -->
  <div class="error-message label-lg" *ngIf="hasBackendError('TherapyCardType')">
    {{ getBackendError('TherapyCardType') }}
  </div>

  <!-- Frontend -->
  <div class="error-message label-lg" *ngIf="hasFrontendError('TherapyCardType')">
    نوع البطاقة مطلوب
  </div>
</div>


  <!-- Notes -->
  <div class="row flex-center width-100">
    <label class="label-lg">الملاحظات</label>
    <textarea rows="1" class="label-lg" formControlName="Notes"></textarea>

    <!-- Backend -->
    <div class="error-message label-lg" *ngIf="hasBackendError('Notes')">
      {{ getBackendError('Notes') }}
    </div>
  </div>

  <!-- Programs section -->
  <div class="width-100">
    <p class="title-md">البرامج العلاجية</p>
    <span class="home-line"></span>
  </div>

 <table class="no-shadow">
  <thead>
    <tr>
      <th class="label-lg">اسم البرنامج</th>
      <th class="label-lg">المدة</th>
      <th class="label-lg">الملاحظات</th>
      <th></th>
    </tr>
  </thead>

  <tbody>
    @for (row of programs.controls; track $index; let i = $index) {
    <tr [formGroup]="row">

      <!-- Program -->
      <td>
        <select class="label-lg" formControlName="MedicalProgramId">
          <option [ngValue]="null">اختر البرنامج</option>
          <option *ngFor="let p of programDropdown" [ngValue]="p.value">
            {{ p.label }}
          </option>
        </select>

        <!-- Frontend Error -->
        <div class="error-message label-lg"
             *ngIf="row.get('MedicalProgramId')?.invalid && row.get('MedicalProgramId')?.touched">
          البرنامج مطلوب
        </div>

        <!-- Backend Error -->
        <div class="error-message label-lg"
             *ngIf="hasBackendError('Programs[' + i + '].MedicalProgramId')">
          {{ getBackendError('Programs[' + i + '].MedicalProgramId') }}
        </div>
      </td>

      <!-- Duration -->
      <td>
        <input class="label-lg" type="number" min="1" formControlName="Duration" />

        <div class="error-message label-lg"
             *ngIf="row.get('Duration')?.invalid && row.get('Duration')?.touched">
          المدة مطلوبة ويجب أن تكون رقمًا أكبر من 0
        </div>

        <div class="error-message label-lg"
             *ngIf="hasBackendError('Programs[' + i + '].Duration')">
          {{ getBackendError('Programs[' + i + '].Duration') }}
        </div>
      </td>

      <!-- Notes -->
      <td>
        <input class="label-lg" type="text" formControlName="Notes" />
      </td>

      <!-- Remove -->
      <td>
        <button *ngIf="programs.length > 1"
                type="button"
                class="btn danger icon"
                (click)="removeProgramRow(i)">
          ✕
        </button>
      </td>

    </tr>
    }
  </tbody>
</table>

  <!-- Duplicate Program Error -->
  <div *ngIf="programs.errors?.['duplicateProgram']"
       class="error-message label-lg flex-center">
    لا يمكن اختيار نفس البرنامج العلاجي أكثر من مرة
  </div>

  <!-- Add program -->
  <div class="flex-end">
    <button class="btn primary" type="button" (click)="addProgramRow()">
      + إضافة برنامج
    </button>
  </div>

  <!-- Submit -->
  <div class="flex-center">
    <button class="btn primary label-md" type="button" (click)="onSubmit()">
      حفظ
    </button>
  </div>

</form>
